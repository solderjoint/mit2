 БМВВ. Руководство программиста.
 
БМВВ следует рассматривать как набор модулей ввода\вывода соединенных шиной CAN 2.0.

Только один из модулей на шине назначается главным. Он производит циклический обмен данными с остальными модулями шины так, что "все знают обо всех".

Для этого каждому модулю ставится в соответствие структура данных одинаковой фиксированной длины (16 байт). Эти структуры расположены (друг за другом) в непрерывной области памяти (1 кБайт для 64 модулей). Эту область оперативной памяти назовем FD (Fast Data, быстрые данные). FD хранится в каждом модуле. Изменяется в результате обмена данными через шину CAN 2.0.

Все модули адресные, адрес соответствует номеру структуры в FD. Модулей одного типа может быть до восьми штук. В зависимости от типа модуля, ему доступен определенный диапазон адресов:
  00-07 - Модули аналоговых входов (тип=0)
  08-15 - Модули аналоговых входов (тип=1)
  24-31 - Модули кнопок управления (тип=3)
  40-47 - Модули дискретных входов (тип=5)
  48-55 - Модули выходов управления (тип=6)
  56-63 - Модули - конвертеры интерфейсов (тип=7)
  
  Конкретный адрес модуля задается тремя джамперами на печатной плате модуля. Модулей одного типа может быть до восьми штук. Адрес формируется из типа модуля и выставленных джамперов по формуле:  Адрес = Тип*8 + Джампера

Рассмотрим более подробно шестнадцатибайтные структуры для всех типов модулей.

Первые 8 байт следует считать входными данными, модуль их принимает из шины CAN 2.0. 
Еще 8 байт - выходные данные, модуль их передает в шину CAN 2.0.

(Особенность главного модуля, что его данные не транслируются в шину CAN2.0, так как физически модуль не опрашивает сам себя через шину CAN 2.0. Также главный модуль задает входные данные для остальных модулей)


Модуль дискретных входов:

IN[0] - не используется
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - биты[0..3] = cостояние входа 1,   биты[4..7] - cостояние входа 2
OUT[1] - биты[0..3] = cостояние входа 3,   биты[4..7] - cостояние входа 4
OUT[2] - биты[0..3] = cостояние входа 5,   биты[4..7] - cостояние входа 6
OUT[3] - биты[0..3] = cостояние входа 7,   биты[4..7] - cостояние входа 8
OUT[4] - не используется
OUT[5] - не используется
OUT[6] - не используется
OUT[7] - не используется
 
  Состояние входа:   
 Обрыв = 0   
 Норма = 1 
 Шум = 2 
 Короткое замыкание = 4
 
Модуль дискретных выходов (модуль выходов управления).

IN[0] - биты [0..7] cоответственно выходы управления [1..8] (1 - включен/0 - выключен).
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - не используется
OUT[1] - не используется
OUT[2] - не используется
OUT[3] - не используется
OUT[4] - не используется
OUT[5] - не используется
OUT[6] - не используется
OUT[7] - не используется
 
Модуль кнопок управления (модуль местного управления).

IN[0] - биты [0..7] cоответственно индикаторы [1..8] (1 - включен/0 - выключен).
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - биты [0..7] cоответственно кнопки [1..8] (1 - нажата/0 - не нажата).
OUT[1] - не используется
OUT[2] - не используется
OUT[3] - не используется
OUT[4] - не используется
OUT[5] - не используется
OUT[6] - не используется
OUT[7] - не используется

Модуль аналоговых входов.

IN[0] - не используется
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - младший байт тока входа 1
OUT[1] - старший байт тока входа 1 (в мкА)
OUT[2] - младший байт тока входа 2
OUT[3] - старший байт тока входа 2 (в мкА)
OUT[4] - младший байт тока входа 3
OUT[5] - старший байт тока входа 3 (в мкА)
OUT[6] - младший байт тока входа 4
OUT[7] - старший байт тока входа 4 (в мкА)

Модуль частотных входов.

IN[0] - не используется
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - младший байт частоты входа 1
OUT[1] - старший байт частоты входа 1 (1=0.1Гц)
OUT[2] - младший байт частоты входа 2
OUT[3] - старший байт частоты входа 2 (1=0.1Гц)
OUT[4] - младший байт частоты входа 3
OUT[5] - старший байт частоты входа 3 (1=0.1Гц)
OUT[6] - младший байт частоты входа 4
OUT[7] - старший байт частоты входа 4 (1=0.1Гц)


Модуль конвертер интерфейсов.

IN[0] - не используется
IN[1] - не используется
IN[2] - не используется
IN[3] - не используется
IN[4] - не используется
IN[5] - не используется
IN[6] - не используется
IN[7] - не используется

OUT[0] - значение температуры датчик 1
OUT[1] - значение температуры датчик 2
OUT[2] - значение температуры датчик 3
OUT[3] - значение температуры датчик 4
OUT[4] - значение температуры датчик 5
OUT[5] - значение температуры датчик 6
OUT[6] - значение температуры датчик 7
OUT[7] - значение температуры датчик 8

Конвертер интерфейсов, если используется как главный, дает возможность доступа к FD через MODBUS RTU протокол:

Регистры с адресами [0-511] - соответственно 1кб FD область для чтения/записи.

Где регистры [0-3] - входные данные модуля с адресом 0,
 регистры [4-7] - выходные данные модуля с адресом 0,
 регистры [8-11] - входные данные модуля с адресом 1,
 регистры [12-15] - выходные данные модуля с адресом 1,
 ...
 регистры [504-507] - входные данные модуля с адресом 63,
 регистры [508-511] - выходные данные модуля с адресом 63.
 
Дополнительно, только для чтения, доступна упакованная последовательность структур данных - только физически присутствующих модулей на шине CAN: 
 регтстр [512] - количество модулей на шине CAN 2.0
 регтстр [513] - резерв
 
 регистры [514-517] - 8 байт присутствия модулей на шине. следует рассматривать как массив бит [0-63] где бит с номером 0 (бит 0 первого байта) это бит присутствия модуля с адресом 0.
 Далее с регистра [518] - по 16 байт на каждый физически присутствующий модуль (непрерывно) от модуля с наименьшим адресом в сторону увеличения адресов.
 
 Например. Блок управления насосом состоит из 6 модулей:
 
 Модуль дисркетных выходов (адрес 0x30).
 Модуль дискретных входов (адрес 0x28).
 Модуль кнопок управления (адрес 0x18).
 Модуль аналоговых входов (адрес 0x00). 
 Модуль аналоговых входов (адрес 0x01). 
 Модуль конвертера интерфесов (адрес 0x38).
 
регистр [512]=0x06 0x00 \ 6 модулей
регистр [513]=0x00 0x00 \ резерв
регистр [514]=0x03 0x00 \ биты присутствия двух аналоговых модулей
регистр [515]=0x00 0x01 \ бит присутствия модуля кнопок управления
регистр [516]=0x00 0x01 \ бит присутствия модуля дискретных входов 
регистр [517]=0x01 0x01 \ биты присутствия модуля дискретных выходов и модуля конвертера интерфейсов
 
регистры [518-525] и 
регистры [526-533] - данные двух аналоговых модулей 
регистры [534-542] - данные модуля кнопок управления
регистры [542-549] - данные модуля дискретных входов 
регистры [550-557] - данные модуля дискретных выходов 
регистры [558-565] - данные модуля конвертера интерфейсов

 
 
